name: Update Documentation Submodules

on:
  schedule:
    # Business hours: Every hour from 7 AM to 6 PM EST (12 PM to 11 PM UTC, Monday-Friday)
    - cron: '0 12-23 * * 1-5'
    # Off hours: Every 6 hours outside business hours
    - cron: '0 0,6,12,18 * * 0,6'  # Weekends every 6 hours
    - cron: '0 0,6 * * 1-5'        # Weekdays off-hours (midnight, 6 AM UTC)
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: false
        type: boolean

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check for existing automated PRs
        id: check-existing-prs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'master'
            });
            
            // Find automated documentation PRs
            const automatedPRs = prs.filter(pr => 
              pr.head.ref.startsWith('automated-docs-update') || 
              pr.title.includes('ðŸ¤– Automated Documentation Updates')
            );
            
            console.log(`Found ${automatedPRs.length} existing automated PRs`);
            
            if (automatedPRs.length > 0) {
              const latestPR = automatedPRs[0]; // Most recent
              console.log(`Latest automated PR: #${latestPR.number} - ${latestPR.title}`);
              core.setOutput('has_existing_pr', 'true');
              core.setOutput('existing_pr_number', latestPR.number.toString());
              core.setOutput('existing_pr_branch', latestPR.head.ref);
              
              // Close older automated PRs (keep only the latest)
              for (let i = 1; i < automatedPRs.length; i++) {
                const oldPR = automatedPRs[i];
                console.log(`Closing outdated automated PR #${oldPR.number}`);
                try {
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: oldPR.number,
                    state: 'closed'
                  });
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: oldPR.number,
                    body: `ðŸ¤– **Auto-closed**: This automated PR has been superseded by a newer update (#${latestPR.number}).`
                  });
                } catch (error) {
                  console.log(`Failed to close PR #${oldPR.number}: ${error.message}`);
                }
              }
            } else {
              core.setOutput('has_existing_pr', 'false');
              core.setOutput('existing_pr_number', '');
              core.setOutput('existing_pr_branch', '');
            }

      - name: Check current submodule commits
        id: check-before
        run: |
          echo "=== Checking current submodule commits ==="
          
          NETBOX_BEFORE=$(git ls-tree HEAD external-repos/netbox | awk '{print $3}' || echo "")
          CONSOLE_BEFORE=$(git ls-tree HEAD external-repos/console-docs | awk '{print $3}' || echo "")
          
          echo "NetBox before: $NETBOX_BEFORE"
          echo "Console before: $CONSOLE_BEFORE"
          
          # Validate output values before writing to GITHUB_OUTPUT
          if [ -n "$NETBOX_BEFORE" ] && [ "$NETBOX_BEFORE" != "" ]; then
            echo "netbox_before=$NETBOX_BEFORE" >> $GITHUB_OUTPUT
          else
            echo "netbox_before=undefined" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$CONSOLE_BEFORE" ] && [ "$CONSOLE_BEFORE" != "" ]; then
            echo "console_before=$CONSOLE_BEFORE" >> $GITHUB_OUTPUT
          else
            echo "console_before=undefined" >> $GITHUB_OUTPUT
          fi

      - name: Update submodules to latest
        run: |
          echo "=== Before submodule update ==="
          git submodule status
          echo "=== Running submodule update ==="
          git submodule update --remote --merge
          echo "=== After submodule update ==="
          git submodule status
          
      - name: Check updated submodule commits
        id: check-after
        run: |
          echo "=== Checking updated submodule commits ==="
          
          NETBOX_AFTER=$(cd external-repos/netbox && git rev-parse HEAD 2>/dev/null || echo "")
          CONSOLE_AFTER=$(cd external-repos/console-docs && git rev-parse HEAD 2>/dev/null || echo "")
          
          echo "NetBox after: $NETBOX_AFTER"
          echo "Console after: $CONSOLE_AFTER"
          
          # Validate output values before writing to GITHUB_OUTPUT
          if [ -n "$NETBOX_AFTER" ] && [ "$NETBOX_AFTER" != "" ]; then
            echo "netbox_after=$NETBOX_AFTER" >> $GITHUB_OUTPUT
          else
            echo "netbox_after=undefined" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$CONSOLE_AFTER" ] && [ "$CONSOLE_AFTER" != "" ]; then
            echo "console_after=$CONSOLE_AFTER" >> $GITHUB_OUTPUT
          else
            echo "console_after=undefined" >> $GITHUB_OUTPUT
          fi

      - name: Debug GITHUB_OUTPUT contents
        run: |
          echo "=== GITHUB_OUTPUT contents ==="
          cat $GITHUB_OUTPUT
          echo "=== End GITHUB_OUTPUT ==="

      - name: Detect changes
        id: changes
        run: |
          NETBOX_CHANGED="false"
          CONSOLE_CHANGED="false"
          
          echo "=== Change Detection Debug ==="
          echo "NetBox before: ${{ steps.check-before.outputs.netbox_before }}"
          echo "NetBox after:  ${{ steps.check-after.outputs.netbox_after }}"
          echo "Console before: ${{ steps.check-before.outputs.console_before }}"
          echo "Console after:  ${{ steps.check-after.outputs.console_after }}"
          
          if [ "${{ steps.check-before.outputs.netbox_before }}" != "${{ steps.check-after.outputs.netbox_after }}" ] && \
             [ "${{ steps.check-before.outputs.netbox_before }}" != "undefined" ] && \
             [ "${{ steps.check-after.outputs.netbox_after }}" != "undefined" ]; then
            NETBOX_CHANGED="true"
          fi
          
          if [ "${{ steps.check-before.outputs.console_before }}" != "${{ steps.check-after.outputs.console_after }}" ] && \
             [ "${{ steps.check-before.outputs.console_before }}" != "undefined" ] && \
             [ "${{ steps.check-after.outputs.console_after }}" != "undefined" ]; then
            CONSOLE_CHANGED="true"
          fi
          
          echo "NetBox changed: $NETBOX_CHANGED"
          echo "Console changed: $CONSOLE_CHANGED"
          echo "Force update: ${{ inputs.force_update }}"
          
          echo "netbox_changed=$NETBOX_CHANGED" >> $GITHUB_OUTPUT
          echo "console_changed=$CONSOLE_CHANGED" >> $GITHUB_OUTPUT
          
          if [ "$NETBOX_CHANGED" = "true" ] || [ "$CONSOLE_CHANGED" = "true" ] || [ "${{ inputs.force_update }}" = "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Early exit notification for no changes
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "âœ… No submodule changes detected - workflow completing successfully"
          echo "- NetBox: ${{ steps.check-before.outputs.netbox_before }} (unchanged)"
          echo "- Console: ${{ steps.check-before.outputs.console_before }} (unchanged)"
          echo "- Force update: ${{ inputs.force_update }}"

      - name: Close existing automated PR if no changes
        if: steps.changes.outputs.has_changes == 'false' && steps.check-existing-prs.outputs.has_existing_pr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-existing-prs.outputs.existing_pr_number }}');
            console.log(`No changes detected - closing existing automated PR #${prNumber}`);
            
            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸ¤– **Auto-closed**: No new documentation changes detected. All submodules are up to date.`
              });
            } catch (error) {
              console.log(`Failed to close automated PR #${prNumber}: ${error.message}`);
            }

      - name: Setup Node.js
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        if: steps.changes.outputs.has_changes == 'true'
        run: yarn install --frozen-lockfile

      - name: Run documentation transformation
        if: steps.changes.outputs.has_changes == 'true'
        run: yarn transform-docs

      - name: Analyze documentation file changes
        if: steps.changes.outputs.has_changes == 'true'
        id: analyze-changes
        run: |
          echo "=== Analyzing documentation file changes ==="
          
          # Initialize counters and lists
          NETBOX_ADDED=0
          NETBOX_MODIFIED=0
          NETBOX_REMOVED=0
          CONSOLE_ADDED=0
          CONSOLE_MODIFIED=0
          CONSOLE_REMOVED=0
          
          # Create temporary files for change lists
          mkdir -p /tmp/doc-changes
          touch /tmp/doc-changes/netbox-added.txt
          touch /tmp/doc-changes/netbox-modified.txt
          touch /tmp/doc-changes/netbox-removed.txt
          touch /tmp/doc-changes/console-added.txt
          touch /tmp/doc-changes/console-modified.txt
          touch /tmp/doc-changes/console-removed.txt
          
          # Get git status for changed files
          git status --porcelain > /tmp/git-status.txt
          
          # Analyze NetBox documentation changes
          if [ "${{ steps.changes.outputs.netbox_changed }}" = "true" ]; then
            echo "Analyzing NetBox documentation changes..."
            
            # Find added files
            grep "^A.*docs/netbox/.*\.md$" /tmp/git-status.txt | sed 's/^A[[:space:]]*//' | while read file; do
              basename "$file" .md >> /tmp/doc-changes/netbox-added.txt
            done
            
            # Find modified files  
            grep "^M.*docs/netbox/.*\.md$" /tmp/git-status.txt | sed 's/^M[[:space:]]*//' | while read file; do
              basename "$file" .md >> /tmp/doc-changes/netbox-modified.txt
            done
            
            # Find removed files
            grep "^D.*docs/netbox/.*\.md$" /tmp/git-status.txt | sed 's/^D[[:space:]]*//' | while read file; do
              basename "$file" .md >> /tmp/doc-changes/netbox-removed.txt
            done
          fi
          
          # Analyze Console documentation changes
          if [ "${{ steps.changes.outputs.console_changed }}" = "true" ]; then
            echo "Analyzing Console documentation changes..."
            
            # Find added files
            grep "^A.*docs/console/.*\.md$" /tmp/git-status.txt | sed 's/^A[[:space:]]*//' | while read file; do
              basename "$file" .md >> /tmp/doc-changes/console-added.txt
            done
            
            # Find modified files
            grep "^M.*docs/console/.*\.md$" /tmp/git-status.txt | sed 's/^M[[:space:]]*//' | while read file; do
              basename "$file" .md >> /tmp/doc-changes/console-modified.txt
            done
            
            # Find removed files
            grep "^D.*docs/console/.*\.md$" /tmp/git-status.txt | sed 's/^D[[:space:]]*//' | while read file; do
              basename "$file" .md >> /tmp/doc-changes/console-removed.txt
            done
          fi
          
          # Count files manually since variables don't persist in subshells
          # Use safer counting that handles empty files properly
          NETBOX_ADDED=$(grep -c "^.*" /tmp/doc-changes/netbox-added.txt 2>/dev/null | grep -v "^0$" || echo "0")
          NETBOX_MODIFIED=$(grep -c "^.*" /tmp/doc-changes/netbox-modified.txt 2>/dev/null | grep -v "^0$" || echo "0")
          NETBOX_REMOVED=$(grep -c "^.*" /tmp/doc-changes/netbox-removed.txt 2>/dev/null | grep -v "^0$" || echo "0")
          CONSOLE_ADDED=$(grep -c "^.*" /tmp/doc-changes/console-added.txt 2>/dev/null | grep -v "^0$" || echo "0")
          CONSOLE_MODIFIED=$(grep -c "^.*" /tmp/doc-changes/console-modified.txt 2>/dev/null | grep -v "^0$" || echo "0")
          CONSOLE_REMOVED=$(grep -c "^.*" /tmp/doc-changes/console-removed.txt 2>/dev/null | grep -v "^0$" || echo "0")
          
          # Filter out empty lines if any
          sed -i '/^$/d' /tmp/doc-changes/*.txt 2>/dev/null || true
          
          # Re-count after filtering empty lines
          NETBOX_ADDED=$(wc -l < /tmp/doc-changes/netbox-added.txt 2>/dev/null || echo "0")
          NETBOX_MODIFIED=$(wc -l < /tmp/doc-changes/netbox-modified.txt 2>/dev/null || echo "0") 
          NETBOX_REMOVED=$(wc -l < /tmp/doc-changes/netbox-removed.txt 2>/dev/null || echo "0")
          CONSOLE_ADDED=$(wc -l < /tmp/doc-changes/console-added.txt 2>/dev/null || echo "0")
          CONSOLE_MODIFIED=$(wc -l < /tmp/doc-changes/console-modified.txt 2>/dev/null || echo "0")
          CONSOLE_REMOVED=$(wc -l < /tmp/doc-changes/console-removed.txt 2>/dev/null || echo "0")
          
          echo "=== Change Summary ==="
          echo "NetBox: +$NETBOX_ADDED ~$NETBOX_MODIFIED -$NETBOX_REMOVED"
          echo "Console: +$CONSOLE_ADDED ~$CONSOLE_MODIFIED -$CONSOLE_REMOVED"
          
          # Validate and set outputs - ensure they're valid integers
          NETBOX_ADDED_SAFE=$(echo "$NETBOX_ADDED" | grep -E '^[0-9]+$' || echo "0")
          NETBOX_MODIFIED_SAFE=$(echo "$NETBOX_MODIFIED" | grep -E '^[0-9]+$' || echo "0")
          NETBOX_REMOVED_SAFE=$(echo "$NETBOX_REMOVED" | grep -E '^[0-9]+$' || echo "0")
          CONSOLE_ADDED_SAFE=$(echo "$CONSOLE_ADDED" | grep -E '^[0-9]+$' || echo "0")
          CONSOLE_MODIFIED_SAFE=$(echo "$CONSOLE_MODIFIED" | grep -E '^[0-9]+$' || echo "0")
          CONSOLE_REMOVED_SAFE=$(echo "$CONSOLE_REMOVED" | grep -E '^[0-9]+$' || echo "0")
          
          echo "netbox_added=$NETBOX_ADDED_SAFE" >> $GITHUB_OUTPUT
          echo "netbox_modified=$NETBOX_MODIFIED_SAFE" >> $GITHUB_OUTPUT  
          echo "netbox_removed=$NETBOX_REMOVED_SAFE" >> $GITHUB_OUTPUT
          echo "console_added=$CONSOLE_ADDED_SAFE" >> $GITHUB_OUTPUT
          echo "console_modified=$CONSOLE_MODIFIED_SAFE" >> $GITHUB_OUTPUT
          echo "console_removed=$CONSOLE_REMOVED_SAFE" >> $GITHUB_OUTPUT

      - name: Determine branch strategy
        if: steps.changes.outputs.has_changes == 'true'
        id: branch-strategy
        run: |
          if [ "${{ steps.check-existing-prs.outputs.has_existing_pr }}" = "true" ]; then
            echo "strategy=update" >> $GITHUB_OUTPUT
            echo "branch_name=${{ steps.check-existing-prs.outputs.existing_pr_branch }}" >> $GITHUB_OUTPUT
            echo "pr_number=${{ steps.check-existing-prs.outputs.existing_pr_number }}" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="automated-docs-update-$(date +%Y%m%d)"
            echo "strategy=create" >> $GITHUB_OUTPUT
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Checkout existing PR branch
        if: steps.changes.outputs.has_changes == 'true' && steps.branch-strategy.outputs.strategy == 'update'
        run: |
          git fetch origin ${{ steps.branch-strategy.outputs.branch_name }}
          git checkout ${{ steps.branch-strategy.outputs.branch_name }}
          git rebase master

      - name: Create new PR branch
        if: steps.changes.outputs.has_changes == 'true' && steps.branch-strategy.outputs.strategy == 'create'
        run: |
          git checkout -b "${{ steps.branch-strategy.outputs.branch_name }}"

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Stage all changes
          git add .
          
          # Check if there are actually changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit after transformation"
            exit 0
          fi
          
          # Create detailed commit message with dynamic content
          NETBOX_CHANGED="${{ steps.changes.outputs.netbox_changed }}"
          CONSOLE_CHANGED="${{ steps.changes.outputs.console_changed }}"
          
          # Build title parts for commit message
          TITLE_PARTS=""
          if [ "$NETBOX_CHANGED" = "true" ]; then
            TITLE_PARTS="NetBox"
          fi
          if [ "$CONSOLE_CHANGED" = "true" ]; then
            if [ -n "$TITLE_PARTS" ]; then
              TITLE_PARTS="$TITLE_PARTS + Console"
            else
              TITLE_PARTS="Console"
            fi
          fi
          
          # Create base commit message
          if [ "${{ steps.branch-strategy.outputs.strategy }}" = "update" ]; then
            COMMIT_MSG="chore: update automated documentation - $TITLE_PARTS"
          else
            COMMIT_MSG="chore: automated documentation updates - $TITLE_PARTS"
          fi
          
          # Add detailed changes
          if [ "$NETBOX_CHANGED" = "true" ]; then
            NETBOX_SHORT_BEFORE="${{ steps.check-before.outputs.netbox_before }}"
            NETBOX_SHORT_AFTER="${{ steps.check-after.outputs.netbox_after }}"
            COMMIT_MSG="$COMMIT_MSG"$'\n\n'"- NetBox docs: ${NETBOX_SHORT_BEFORE:0:7} â†’ ${NETBOX_SHORT_AFTER:0:7}"
          fi
          
          if [ "$CONSOLE_CHANGED" = "true" ]; then
            CONSOLE_SHORT_BEFORE="${{ steps.check-before.outputs.console_before }}"
            CONSOLE_SHORT_AFTER="${{ steps.check-after.outputs.console_after }}"
            COMMIT_MSG="$COMMIT_MSG"$'\n\n'"- Console docs: ${CONSOLE_SHORT_BEFORE:0:7} â†’ ${CONSOLE_SHORT_AFTER:0:7}"
          fi
          
          COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Automated by GitHub Actions - includes transformed documentation files"
          
          git commit -m "$COMMIT_MSG"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: git push origin "${{ steps.branch-strategy.outputs.branch_name }}" --force-with-lease

      - name: Create or Update Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Get the change status from workflow outputs
            const netboxChanged = '${{ steps.changes.outputs.netbox_changed }}' === 'true';
            const consoleChanged = '${{ steps.changes.outputs.console_changed }}' === 'true';
            
            console.log(`NetBox changed: ${netboxChanged}, Console changed: ${consoleChanged}`);
            
            // Get file change counts
            const netboxAdded = parseInt('${{ steps.analyze-changes.outputs.netbox_added }}') || 0;
            const netboxModified = parseInt('${{ steps.analyze-changes.outputs.netbox_modified }}') || 0;
            const netboxRemoved = parseInt('${{ steps.analyze-changes.outputs.netbox_removed }}') || 0;
            const consoleAdded = parseInt('${{ steps.analyze-changes.outputs.console_added }}') || 0;
            const consoleModified = parseInt('${{ steps.analyze-changes.outputs.console_modified }}') || 0;
            const consoleRemoved = parseInt('${{ steps.analyze-changes.outputs.console_removed }}') || 0;
            
            console.log(`File change counts:`);
            console.log(`- NetBox: +${netboxAdded} ~${netboxModified} -${netboxRemoved}`);
            console.log(`- Console: +${consoleAdded} ~${consoleModified} -${consoleRemoved}`);
            
            // Build the PR body content
            let netboxStatus = '';
            let consoleStatus = '';
            
            if (netboxChanged) {
              const netboxChangeSummary = `+${netboxAdded} ~${netboxModified} -${netboxRemoved}`;
              netboxStatus = `- âœ… **NetBox Documentation**: Updated from \`${{ steps.check-before.outputs.netbox_before }}\` to \`${{ steps.check-after.outputs.netbox_after }}\` (${netboxChangeSummary})`;
            } else {
              netboxStatus = '- âšª **NetBox Documentation**: No changes';
            }
            
            if (consoleChanged) {
              const consoleChangeSummary = `+${consoleAdded} ~${consoleModified} -${consoleRemoved}`;
              consoleStatus = `- âœ… **Console Documentation**: Updated from \`${{ steps.check-before.outputs.console_before }}\` to \`${{ steps.check-after.outputs.console_after }}\` (${consoleChangeSummary})`;
            } else {
              consoleStatus = '- âšª **Console Documentation**: No changes';
            }
            
            // Build dynamic title based on what changed
            let titleParts = [];
            if (netboxChanged) titleParts.push('NetBox');
            if (consoleChanged) titleParts.push('Console');
            
            const dynamicTitle = titleParts.length > 0 
              ? `ðŸ¤– Automated Documentation Updates - ${titleParts.join(' + ')}`
              : 'ðŸ¤– Automated Documentation Updates';
            
            const isUpdate = '${{ steps.branch-strategy.outputs.strategy }}' === 'update';
            const updateText = isUpdate ? ' (Updated)' : '';
            
            // Build detailed what's included section
            let whatsIncluded = ['- ðŸ“š Updated submodule references to latest commits'];
            
            if (netboxChanged || consoleChanged) {
              whatsIncluded.push('- ðŸ”„ Regenerated transformed documentation files');
              whatsIncluded.push('- ðŸ—‚ï¸ Updated sidebar configurations');
              whatsIncluded.push('- ðŸ–¼ï¸ Copied new/updated static assets');
              
              if (netboxChanged) {
                whatsIncluded.push(`- ðŸ“– **NetBox docs**: ~284 files processed and transformed (${netboxAdded + netboxModified + netboxRemoved} changes)`);
              }
              if (consoleChanged) {
                whatsIncluded.push(`- ðŸ¢ **Console docs**: ~324 files processed and transformed (${consoleAdded + consoleModified + consoleRemoved} changes)`);
              }
            }
            
            // Build detailed file changes section
            let fileChangesSection = '';
            
            if (netboxChanged || consoleChanged) {
              const { execSync } = require('child_process');
              let fileChangesParts = [];
              
              if (netboxChanged && (netboxAdded > 0 || netboxModified > 0 || netboxRemoved > 0)) {
                let netboxChanges = [];
                
                if (netboxAdded > 0) {
                  try {
                    const addedFiles = execSync('cat /tmp/doc-changes/netbox-added.txt 2>/dev/null || echo ""', { encoding: 'utf8' }).trim();
                    if (addedFiles) {
                      const fileList = addedFiles.split('\n').filter(f => f.trim()).slice(0, 10);
                      const moreText = addedFiles.split('\n').length > 10 ? ` (+${addedFiles.split('\n').length - 10} more)` : '';
                      netboxChanges.push(`**Added (${netboxAdded}):** ${fileList.join(', ')}${moreText}`);
                    }
                  } catch (e) {
                    netboxChanges.push(`**Added:** ${netboxAdded} files`);
                  }
                }
                
                if (netboxModified > 0) {
                  try {
                    const modifiedFiles = execSync('cat /tmp/doc-changes/netbox-modified.txt 2>/dev/null || echo ""', { encoding: 'utf8' }).trim();
                    if (modifiedFiles) {
                      const fileList = modifiedFiles.split('\n').filter(f => f.trim()).slice(0, 10);
                      const moreText = modifiedFiles.split('\n').length > 10 ? ` (+${modifiedFiles.split('\n').length - 10} more)` : '';
                      netboxChanges.push(`**Modified (${netboxModified}):** ${fileList.join(', ')}${moreText}`);
                    }
                  } catch (e) {
                    netboxChanges.push(`**Modified:** ${netboxModified} files`);
                  }
                }
                
                if (netboxRemoved > 0) {
                  try {
                    const removedFiles = execSync('cat /tmp/doc-changes/netbox-removed.txt 2>/dev/null || echo ""', { encoding: 'utf8' }).trim();
                    if (removedFiles) {
                      const fileList = removedFiles.split('\n').filter(f => f.trim()).slice(0, 10);
                      const moreText = removedFiles.split('\n').length > 10 ? ` (+${removedFiles.split('\n').length - 10} more)` : '';
                      netboxChanges.push(`**Removed (${netboxRemoved}):** ${fileList.join(', ')}${moreText}`);
                    }
                  } catch (e) {
                    netboxChanges.push(`**Removed:** ${netboxRemoved} files`);
                  }
                }
                
                if (netboxChanges.length > 0) {
                  fileChangesParts.push(`#### ðŸ“– NetBox Documentation\n${netboxChanges.join('\n')}`);
                }
              }
              
              if (consoleChanged && (consoleAdded > 0 || consoleModified > 0 || consoleRemoved > 0)) {
                let consoleChanges = [];
                
                if (consoleAdded > 0) {
                  try {
                    const addedFiles = execSync('cat /tmp/doc-changes/console-added.txt 2>/dev/null || echo ""', { encoding: 'utf8' }).trim();
                    if (addedFiles) {
                      const fileList = addedFiles.split('\n').filter(f => f.trim()).slice(0, 10);
                      const moreText = addedFiles.split('\n').length > 10 ? ` (+${addedFiles.split('\n').length - 10} more)` : '';
                      consoleChanges.push(`**Added (${consoleAdded}):** ${fileList.join(', ')}${moreText}`);
                    }
                  } catch (e) {
                    consoleChanges.push(`**Added:** ${consoleAdded} files`);
                  }
                }
                
                if (consoleModified > 0) {
                  try {
                    const modifiedFiles = execSync('cat /tmp/doc-changes/console-modified.txt 2>/dev/null || echo ""', { encoding: 'utf8' }).trim();
                    if (modifiedFiles) {
                      const fileList = modifiedFiles.split('\n').filter(f => f.trim()).slice(0, 10);
                      const moreText = modifiedFiles.split('\n').length > 10 ? ` (+${modifiedFiles.split('\n').length - 10} more)` : '';
                      consoleChanges.push(`**Modified (${consoleModified}):** ${fileList.join(', ')}${moreText}`);
                    }
                  } catch (e) {
                    consoleChanges.push(`**Modified:** ${consoleModified} files`);
                  }
                }
                
                if (consoleRemoved > 0) {
                  try {
                    const removedFiles = execSync('cat /tmp/doc-changes/console-removed.txt 2>/dev/null || echo ""', { encoding: 'utf8' }).trim();
                    if (removedFiles) {
                      const fileList = removedFiles.split('\n').filter(f => f.trim()).slice(0, 10);
                      const moreText = removedFiles.split('\n').length > 10 ? ` (+${removedFiles.split('\n').length - 10} more)` : '';
                      consoleChanges.push(`**Removed (${consoleRemoved}):** ${fileList.join(', ')}${moreText}`);
                    }
                  } catch (e) {
                    consoleChanges.push(`**Removed:** ${consoleRemoved} files`);
                  }
                }
                
                if (consoleChanges.length > 0) {
                  fileChangesParts.push(`#### ðŸ¢ Console Documentation\n${consoleChanges.join('\n')}`);
                }
              }
              
              if (fileChangesParts.length > 0) {
                fileChangesSection = [
                  '',
                  '### ðŸ“„ Detailed File Changes',
                  '',
                  '<details>',
                  '<summary>Click to view specific file changes</summary>',
                  '',
                  ...fileChangesParts,
                  '',
                  '</details>'
                ].join('\n');
              }
            }
            
            const prBody = [
              '## ðŸ”„ Automated Submodule Updates' + updateText,
              '',
              'This PR contains automated updates to documentation submodules and their transformed content.',
              '',
              isUpdate ? `> **ðŸ”„ This PR was automatically updated on ${new Date().toISOString()}**` : '',
              '',
              '### ðŸ“Š Changes Detected',
              '',
              netboxStatus,
              '',
              consoleStatus,
              '',
              '### ðŸ“¦ What\'s Included',
              '',
              ...whatsIncluded,
              fileChangesSection,
              '',
              '### Review Checklist',
              '',
              '- [ ] Check that new/updated documentation renders correctly',
              '- [ ] Verify no broken links or missing images',
              '- [ ] Confirm sidebar navigation is working properly',
              '- [ ] Test build process completes successfully',
              '',
              '### Auto-merge Criteria',
              '',
              'This PR can be safely auto-merged if:',
              '- [ ] All CI checks pass',
              '- [ ] No conflicts with base branch',
              '- [ ] Documentation transformation completed successfully',
              '',
              '---',
              '',
              '*This PR was automatically generated by the `update-submodules` GitHub Action.*',
              `*Last updated: ${new Date().toISOString()}*`
            ].join('\n');

            if (isUpdate) {
              // Update existing PR
              const prNumber = ${{ steps.branch-strategy.outputs.pr_number }};
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                title: dynamicTitle,
                body: prBody
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸ¤– **Auto-updated** with latest documentation changes (${new Date().toISOString()})`
              });
              
              console.log(`Updated existing PR #${prNumber}`);
            } else {
              // Create new PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: dynamicTitle,
                head: '${{ steps.branch-strategy.outputs.branch_name }}',
                base: 'master',
                body: prBody,
                draft: false
              });

              // Add labels
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['documentation', 'automated', 'submodule-update']
              });

              console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            }

      - name: Summary
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          
          HAS_CHANGES="${{ steps.changes.outputs.has_changes }}"
          NETBOX_CHANGED="${{ steps.changes.outputs.netbox_changed }}"
          CONSOLE_CHANGED="${{ steps.changes.outputs.console_changed }}"
          FORCE_UPDATE="${{ inputs.force_update }}"
          
          echo "Has changes: $HAS_CHANGES"
          echo "NetBox changed: $NETBOX_CHANGED"
          echo "Console changed: $CONSOLE_CHANGED"
          echo "Force update: $FORCE_UPDATE"
          
          if [ "$HAS_CHANGES" = "true" ]; then
            echo "âœ… Documentation updates detected and PR ${{ steps.branch-strategy.outputs.strategy }}d"
            echo "- NetBox changed: $NETBOX_CHANGED"
            echo "- Console changed: $CONSOLE_CHANGED"
            echo "- Strategy: ${{ steps.branch-strategy.outputs.strategy }}"
          else
            echo "âœ… No documentation changes detected - workflow completed successfully"
            echo "- All submodules are up to date"
            if [ "${{ steps.check-existing-prs.outputs.has_existing_pr }}" = "true" ]; then
              echo "ðŸ§¹ Closed existing automated PR as no changes were needed"
            fi
          fi 